graph TD
    %% ============================================
    %% EXTERNAL WORLD - Внешние интерфейсы
    %% ============================================
    subgraph EXT["External World (Clients/Channels)"]
        USER[("User<br/>Клиент")]
        TG_API["Telegram API<br/>(Webhooks)"]
        WA_API["WhatsApp<br/>Business API"]
        VOIP["Telephony Provider<br/>(VoIP/SIP Trunk)"]
    end

    %% ============================================
    %% INGESTION LAYER - Слой приема данных
    %% ============================================
    subgraph INGESTION["Ingestion Layer (Gateway)"]
        API_GW["API Gateway<br/>(FastAPI)<br/>Multi-tenant<br/>Webhook Receiver"]
        STT["STT Module<br/>(Speech-to-Text)<br/>Google/Whisper"]
        TTS["TTS Module<br/>(Text-to-Speech)<br/>Google/ElevenLabs"]
    end

    %% ============================================
    %% CORE LOGIC - Ядро агента
    %% ============================================
    subgraph CORE["Core Logic (Python Agent)"]
        ORCH["Orchestrator<br/>Главный контроллер<br/>диалога<br/>(Multi-tenant)"]
        PROMPT_MGR["Prompt Manager<br/>Управление<br/>системными промптами"]
        TOOL_MGR["Tool/Function<br/>Calling Manager<br/>Роутинг действий"]
        CRM_FACTORY["CRM Factory<br/>Динамическое создание<br/>CRM адаптеров"]
    end

    %% ============================================
    %% AI LAYER - Слой интеллекта
    %% ============================================
    subgraph AI["AI Layer"]
        GEMINI["Google Gemini API<br/>(LLM)<br/>Генерация ответов<br/>Function Calling"]
    end

    %% ============================================
    %% DATA LAYER - Слой данных
    %% ============================================
    subgraph DATA["Data & State Layer (Multi-tenant)"]
        REDIS[("Redis<br/>Session State Storage<br/>Контекст диалога")]
        POSTGRES[("PostgreSQL<br/>Companies (Multi-tenant)<br/>CRM Settings<br/>Agent Settings<br/>Channels<br/>Логи, аналитика")]
    end

    %% ============================================
    %% INTEGRATIONS - Внешние интеграции
    %% ============================================
    subgraph INTEGRATIONS["External Integrations (Per Company)"]
        CRM1["YCLIENTS<br/>(Company A)"]
        CRM2["Битрикс24<br/>(Company B)"]
        CRM3["DIKIDI<br/>(Company C)"]
        CRM4["1C<br/>(Company D)"]
    end

    %% ============================================
    %% CONNECTIONS - Связи
    %% ============================================

    %% User -> Channels
    USER -->|"Пишет сообщение"| TG_API
    USER -->|"Пишет сообщение"| WA_API
    USER -->|"Звонит"| VOIP

    %% Channels -> API Gateway
    TG_API -->|"Webhook event<br/>(с webhook_token)"| API_GW
    WA_API -->|"Webhook event<br/>(с webhook_token)"| API_GW
    VOIP -->|"Входящий аудиопоток"| API_GW

    %% API Gateway -> PostgreSQL (определение company_id)
    API_GW -->|"Поиск company_id<br/>по webhook_token"| POSTGRES
    POSTGRES -->|"company_id,<br/>channel config"| API_GW

    %% API Gateway -> STT (для голоса)
    API_GW -->|"Аудио данные"| STT
    STT -->|"Транскрибированный текст"| ORCH

    %% API Gateway -> Orchestrator (для текста)
    API_GW -->|"Message<br/>(с company_id)"| ORCH

    %% Orchestrator -> PostgreSQL (загрузка настроек компании)
    ORCH -->|"Загрузка CRM settings<br/>и company context"| POSTGRES
    POSTGRES -->|"CRM config,<br/>business info,<br/>services catalog"| ORCH

    %% Orchestrator -> CRM Factory
    ORCH -->|"Создать CRM адаптер<br/>для company"| CRM_FACTORY
    CRM_FACTORY -->|"CRM адаптер<br/>(YCLIENTS/Bitrix24/etc)"| ORCH

    %% Orchestrator <-> Session State
    ORCH <-->|"Загрузка/сохранение<br/>контекста диалога"| REDIS

    %% Orchestrator -> Prompt Manager
    ORCH -->|"Запрос промпта<br/>(с company context)"| PROMPT_MGR
    PROMPT_MGR -->|"System prompt<br/>(персонализированный)"| ORCH

    %% Orchestrator -> AI Layer
    ORCH -->|"Запрос к LLM<br/>(prompt + context)"| GEMINI
    GEMINI -->|"Ответ LLM<br/>(text/function_call)"| ORCH

    %% Orchestrator -> Tool Manager
    ORCH -->|"Function call от LLM"| TOOL_MGR
    TOOL_MGR -->|"Результат выполнения"| ORCH

    %% Tool Manager -> CRM (через адаптер компании)
    TOOL_MGR -->|"REST API запрос"| CRM1
    TOOL_MGR -->|"REST API запрос"| CRM2
    TOOL_MGR -->|"REST API запрос"| CRM3
    TOOL_MGR -->|"REST API запрос"| CRM4
    CRM1 -->|"JSON ответ"| TOOL_MGR
    CRM2 -->|"JSON ответ"| TOOL_MGR
    CRM3 -->|"JSON ответ"| TOOL_MGR
    CRM4 -->|"JSON ответ"| TOOL_MGR

    %% Tool Manager -> Database
    TOOL_MGR -->|"Запись логов"| POSTGRES

    %% Orchestrator -> TTS (для голоса)
    ORCH -->|"Текст ответа"| TTS
    TTS -->|"Аудио ответ"| API_GW

    %% Orchestrator -> API Gateway (для текста)
    ORCH -->|"Текст ответа"| API_GW

    %% API Gateway -> Channels (ответы)
    API_GW -->|"Отправка сообщения"| TG_API
    API_GW -->|"Отправка сообщения"| WA_API
    API_GW -->|"Исходящий аудиопоток"| VOIP

    %% Channels -> User
    TG_API -->|"Ответ агента"| USER
    WA_API -->|"Ответ агента"| USER
    VOIP -->|"Голосовой ответ"| USER

    %% Analytics logging
    ORCH -->|"Логирование сессий<br/>и сообщений"| POSTGRES

    %% ============================================
    %% STYLING
    %% ============================================
    classDef external fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef gateway fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef core fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef ai fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    classDef data fill:#fce4ec,stroke:#c2185b,stroke-width:2px
    classDef integration fill:#fffde7,stroke:#f9a825,stroke-width:2px

    class USER,TG_API,WA_API,VOIP external
    class API_GW,STT,TTS gateway
    class ORCH,PROMPT_MGR,TOOL_MGR core
    class GEMINI ai
    class REDIS,POSTGRES data
    class CRM integration
