# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

AI-Admin ‚Äî —ç—Ç–æ –ò–ò-–∞–≥–µ–Ω—Ç –Ω–∞ Python –¥–ª—è **–ø–æ–ª–Ω–æ–π –∑–∞–º–µ–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ –∏ —Ö–æ—Å—Ç–µ—Å—Å –≤ –±–∏–∑–Ω–µ—Å–µ**. –°–∏—Å—Ç–µ–º–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–∞–Ω–∞–ª–æ–≤: Telegram, WhatsApp –∏ –≥–æ–ª–æ—Å–æ–≤—ã–µ –∑–≤–æ–Ω–∫–∏.

**–¶–µ–ª–µ–≤–æ–π —Ä—ã–Ω–æ–∫**: –†–æ—Å—Å–∏–π—Å–∫–∞—è –§–µ–¥–µ—Ä–∞—Ü–∏—è
**–¶–µ–ª—å –ø—Ä–æ–µ–∫—Ç–∞**: –í—ã–≤–æ–¥ –ø—Ä–æ–¥—É–∫—Ç–∞ –Ω–∞ —Ä—ã–Ω–æ–∫ —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ª–µ–≥–∫–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –≤ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ CRM-—Å–∏—Å—Ç–µ–º—ã, –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –≤ –†–§

**–ë–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å**: SAAS (Software as a Service) / Multi-tenant

### –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
- –ü—Ä–∏–µ–º –≤—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–æ–≤
- –û–±—â–µ–Ω–∏–µ –≤ Telegram –∏ WhatsApp
- –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤
- –ó–∞–ø–∏—Å—å –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ —É—Å–ª—É–≥–∏
- –†–∞–±–æ—Ç–∞ —Å CRM (—Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–µ–π, –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–ª–æ—Ç–æ–≤, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π –±–∞–∑–æ–π)

## –í–ê–ñ–ù–û: Multi-tenant –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

**–≠—Ç–æ SAAS –ø—Ä–æ–¥—É–∫—Ç –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–∞ –∫–æ–º–ø–∞–Ω–∏–π, –ù–ï single-tenant –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ!**

### –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **–ö–ª–∏–µ–Ω—Ç (–∫–æ–º–ø–∞–Ω–∏—è)** —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Å–∞–π—Ç–µ AI-Admin
2. –í **–∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –Ω–∞ —Å–∞–π—Ç–µ** –∫–ª–∏–µ–Ω—Ç:
   - –í—ã–±–∏—Ä–∞–µ—Ç —Å–≤–æ—é CRM (YCLIENTS, DIKIDI, –ë–∏—Ç—Ä–∏–∫—Å24, 1C)
   - –£–∫–∞–∑—ã–≤–∞–µ—Ç API –∫–ª—é—á –∏ –¥—Ä—É–≥–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–≤–æ–µ–π CRM
   - –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∞–≥–µ–Ω—Ç–∞ (–Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏, —á–∞—Å—ã —Ä–∞–±–æ—Ç—ã, –ø—Ä–æ–º–ø—Ç—ã)
   - –ü–æ–¥–∫–ª—é—á–∞–µ—Ç –∫–∞–Ω–∞–ª—ã (Telegram –±–æ—Ç, WhatsApp, —Ç–µ–ª–µ—Ñ–æ–Ω–∏—è)
3. **–í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ PostgreSQL** –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–µ –∫ `company_id`
4. **AI Agent –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç** –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é CRM –¥–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–ø–∞–Ω–∏–∏ –∏–∑ –ë–î

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î:

```sql
companies (
  id,
  name,
  created_at,
  subscription_plan
)

company_crm_settings (
  id,
  company_id,
  crm_type,        -- 'yclients', 'dikidi', 'bitrix24', '1c'
  api_key,         -- –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω!
  base_url,
  additional_settings  -- JSON –¥–ª—è CRM-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
)

company_agent_settings (
  id,
  company_id,
  company_description,
  working_hours,
  custom_prompts     -- JSON —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –ø—Ä–æ–º–ø—Ç–∞–º–∏
)

company_channels (
  id,
  company_id,
  channel_type,      -- 'telegram', 'whatsapp', 'voice'
  is_active,
  config             -- JSON —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ –∫–∞–Ω–∞–ª–∞
)
```

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (CRM_TYPE, CRM_API_KEY):

**–≠—Ç–æ —Ç–æ–ª—å–∫–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!**

–í production:
- ‚ùå –ù–ï–¢ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è CRM
- ‚úÖ –ö–∞–∂–¥–∞—è –∫–æ–º–ø–∞–Ω–∏—è –∏–º–µ–µ—Ç —Å–≤–æ–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –ë–î
- ‚úÖ AI Agent –ø–æ–ª—É—á–∞–µ—Ç `company_id` –∏–∑ –≤—Ö–æ–¥—è—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- ‚úÖ AI Agent –∑–∞–≥—Ä—É–∂–∞–µ—Ç CRM –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –ë–î –ø–æ `company_id`
- ‚úÖ –°–æ–∑–¥–∞–µ—Ç—Å—è CRM –∞–¥–∞–ø—Ç–µ—Ä –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–æ–º–ø–∞–Ω–∏–∏

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ:

**Orchestrator –¥–æ–ª–∂–µ–Ω:**
```python
async def handle_message(self, message: Message) -> Dict:
    # 1. –ò–∑–≤–ª–µ—á—å company_id –∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è
    company_id = message.metadata.get("company_id")

    # 2. –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–ø–∞–Ω–∏–∏ –∏–∑ –ë–î
    company_settings = await self.db.get_company_settings(company_id)

    # 3. –°–æ–∑–¥–∞—Ç—å CRM –∞–¥–∞–ø—Ç–µ—Ä –¥–ª—è —ç—Ç–æ–π –∫–æ–º–ø–∞–Ω–∏–∏
    crm_adapter = CRMFactory.create(
        crm_type=company_settings.crm_type,
        api_key=company_settings.crm_api_key,
        base_url=company_settings.crm_base_url
    )

    # 4. –û–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ —Å CRM —ç—Ç–æ–π –∫–æ–º–ø–∞–Ω–∏–∏
    ...
```

**API Gateway –¥–æ–ª–∂–µ–Ω:**
- –û–ø—Ä–µ–¥–µ–ª—è—Ç—å `company_id` –∏–∑ webhook URL –∏–ª–∏ —Ç–æ–∫–µ–Ω–∞
- –î–æ–±–∞–≤–ª—è—Ç—å `company_id` –≤ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ü—Ä–∏–º–µ—Ä: `/api/v1/telegram/webhook/{company_id}` –∏–ª–∏ —á–µ—Ä–µ–∑ API token

### –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ CRM:

–°–æ–≥–ª–∞—Å–Ω–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—é —Ä—ã–Ω–∫–∞ 2026:
- **YCLIENTS** - —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —Å–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π –≤—ã–±–æ—Ä –∫–ª–∏–µ–Ω—Ç–æ–≤
- DIKIDI - –≤—Ç–æ—Ä–æ–π –ø–æ –ø–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç–∏
- –ë–∏—Ç—Ä–∏–∫—Å24 - –¥–ª—è –º–∞–ª–æ–≥–æ/—Å—Ä–µ–¥–Ω–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞
- 1C - –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π —Å–µ–≥–º–µ–Ω—Ç

## Development Approach

–ü—Ä–∏ —Ä–∞–±–æ—Ç–µ –Ω–∞–¥ —ç—Ç–∏–º –ø—Ä–æ–µ–∫—Ç–æ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:

### Senior Developer Mindset
- –î–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –∫–∞–∫ Senior —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ –∏ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ—Å—Ç—å
- –ü—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ—à–µ–Ω–∏—è —Å —É—á–µ—Ç–æ–º –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏ –∏ —Ä–∞—Å—à–∏—Ä—è–µ–º–æ—Å—Ç–∏
- –ü–∏—Å–∞—Ç—å —á–∏—Å—Ç—ã–π, –ø–æ–Ω—è—Ç–Ω—ã–π –∫–æ–¥ —Å —á–µ—Ç–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
- –î–µ–ª–∞—Ç—å –∑–∞–¥–µ–ª –Ω–∞ –±—É–¥—É—â–∏–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### Research & –ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å
**–í–ê–ñ–ù–û**: –í—Å–µ–≥–¥–∞ –∏—Å–∫–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ –ø–æ:
- API –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö CRM-—Å–∏—Å—Ç–µ–º –≤ –†–§ –∏ –∏—Ö –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
- –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–º —Ñ—Ä–µ–π–º–≤–æ—Ä–∫–∞–º –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞–º (–ø—Ä–æ–≤–µ—Ä—è—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ –∏ best practices)
- –ò–∑–º–µ–Ω–µ–Ω–∏—è–º –≤ API –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (Telegram, WhatsApp, Google Gemini –∏ —Ç.–¥.)

### –ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
- **–ß–µ—Ç–∫–∞—è –º–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞**: –∫–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–º –∏ –ª–µ–≥–∫–æ –∑–∞–º–µ–Ω—è–µ–º—ã–º
- **Plugin-based CRM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏**: –∫–∞–∂–¥–∞—è CRM –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–º –º–æ–¥—É–ª–µ–º —Å –µ–¥–∏–Ω—ã–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
- **–õ–µ–≥–∫–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –Ω–æ–≤—ã—Ö –∫–∞–Ω–∞–ª–æ–≤**: –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–æ–ª–∂–Ω–∞ –ø–æ–∑–≤–æ–ª—è—Ç—å –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –∫–∞–Ω–∞–ª—ã —Å–≤—è–∑–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —è–¥—Ä–∞
- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º–æ—Å—Ç—å**: –º–∞–∫—Å–∏–º—É–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —á–µ—Ä–µ–∑ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### Target CRM Systems (–†–§)
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ CRM –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏** (–ø–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—é —Ä—ã–Ω–∫–∞ –†–§):

**–¢–æ–ø-4 (–ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é):**
1. **YCLIENTS** - –ª–∏–¥–µ—Ä –¥–ª—è —Å–∞–ª–æ–Ω–æ–≤ –∫—Ä–∞—Å–æ—Ç—ã, —Ñ–∏—Ç–Ω–µ—Å–∞, –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Ü–µ–Ω—Ç—Ä–æ–≤, –°–ü–ê
2. **DIKIDI** - –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç YClients, –ø–æ–ø—É–ª—è—Ä–µ–Ω –≤ beauty-—Å–µ–≥–º–µ–Ω—Ç–µ
3. **1C** (1–°:–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ) - –¥–æ–º–∏–Ω–∏—Ä—É—é—â–∞—è —Å–∏—Å—Ç–µ–º–∞ —É—á–µ—Ç–∞ –∏ CRM –≤ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–º —Å–µ–≥–º–µ–Ω—Ç–µ –†–§
4. **–ë–∏—Ç—Ä–∏–∫—Å24** (Bitrix24) - –∫–æ–º–ø–ª–µ–∫—Å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –º–∞–ª–æ–≥–æ –∏ —Å—Ä–µ–¥–Ω–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã –¥–ª—è —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏—è:**
- **amoCRM** - –ø–æ–ø—É–ª—è—Ä–Ω–∞—è CRM –¥–ª—è –º–∞–ª–æ–≥–æ –∏ —Å—Ä–µ–¥–Ω–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞
- **–ú–æ–π–°–∫–ª–∞–¥** - –¥–ª—è —Ç–æ—Ä–≥–æ–≤–ª–∏ –∏ —É—Å–ª—É–≥
- **Planfix** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞–º–∏ –∏ CRM

**–í–ê–ñ–ù–û**: –°–ø–∏—Å–æ–∫ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ –º–æ–∂–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π —Ä—ã–Ω–∫–∞ –∏ –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏ –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤.

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø–æ–¥—Ö–æ–¥**: —Ä–∞–∑—Ä–∞–±–æ—Ç–∞—Ç—å –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π CRM-–∞–¥–∞–ø—Ç–µ—Ä –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–∞–ª–∏–∑—É—é—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ CRM-–º–æ–¥—É–ª–∏. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç - –Ω–∞—á–∞—Ç—å —Å –¢–æ–ø-4 —Å–∏—Å—Ç–µ–º.

#### API –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å (–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —è–Ω–≤–∞—Ä—å 2026):

**YCLIENTS**:
- ‚úÖ REST API –¥–æ—Å—Ç—É–ø–µ–Ω ([–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://yclientsru.docs.apiary.io/))
- ‚ö†Ô∏è Webhook: —Å 12.09.2022 –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –ª–æ–≥–∏–∫–∞ - –Ω–æ–≤—ã–µ webhook –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ Marketplace
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —á–µ—Ä–µ–∑ bearer token —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞: –∑–∞–ø–∏—Å—å –∫–ª–∏–µ–Ω—Ç–æ–≤, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ª–æ—Ç–∞–º–∏, —Ä–∞–±–æ—Ç–∞ —Å –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–π –±–∞–∑–æ–π

**DIKIDI**:
- ‚ö†Ô∏è API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞, –Ω–µ–æ–±—Ö–æ–¥–∏–º –∫–æ–Ω—Ç–∞–∫—Ç —Å–æ —Å–ª—É–∂–±–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏
- –î–æ—Å—Ç—É–ø —á–µ—Ä–µ–∑ Settings -> Integration -> API Access
- –°—É—â–µ—Å—Ç–≤—É–µ—Ç [–Ω–µ–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π wrapper –Ω–∞ GitHub](https://github.com/ixtora/dikidi-api)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Callback API –¥–ª—è webhooks

**–ë–∏—Ç—Ä–∏–∫—Å24**:
- ‚úÖ –ü–æ–ª–Ω–∞—è [REST API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://apidocs.bitrix24.ru/)
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö –∏ –∏—Å—Ö–æ–¥—è—â–∏—Ö webhooks
- –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥–ø–∏—Å–∫–∞ Marketplace –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è webhooks
- –ê–∫—Ç–∏–≤–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –≤ –∞–≤–≥—É—Å—Ç–µ 2025

**1C:–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ**:
- ‚úÖ REST API —á–µ—Ä–µ–∑ OData –ø—Ä–æ—Ç–æ–∫–æ–ª 3.0
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ SOAP –≤–µ–±-—Å–µ—Ä–≤–∏—Å–æ–≤
- –§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö: JSON / Atom/XML
- –ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ 8.5 –¥–æ–±–∞–≤–∏–ª–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É REST API 2.0
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞ —Å—Ç–æ—Ä–æ–Ω–µ 1C

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—É —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏**:
1. –ë–∏—Ç—Ä–∏–∫—Å24 (–ª—É—á—à–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏ API)
2. YCLIENTS (—á–µ—Ä–µ–∑ Marketplace)
3. 1C (—Ç—Ä–µ–±—É–µ—Ç –±–æ–ª—å—à–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫)
4. DIKIDI (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)

## Architecture

**–í–ê–ñ–ù–û**: –ü–æ–ª–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `docs/architecture.mmd` ‚Äî –≤—Å–µ–≥–¥–∞ –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ —ç—Ç–æ–π –¥–∏–∞–≥—Ä–∞–º–º–µ –ø—Ä–∏ –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.

–°–∏—Å—Ç–µ–º–∞ —Å–ª–µ–¥—É–µ—Ç –º–Ω–æ–≥–æ—Å–ª–æ–π–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ:

### Ingestion Layer (Gateway)
- **API Gateway (FastAPI)**: Central webhook receiver for all channels
- **STT Module**: Speech-to-Text conversion (Google/Whisper) for voice calls
- **TTS Module**: Text-to-Speech synthesis (Google/ElevenLabs) for voice responses
- Receives events from Telegram API, WhatsApp Business API, and VoIP telephony providers

### Core Logic Layer
- **Orchestrator**: Main dialogue controller that manages conversation flow
  - Loads/saves conversation context from Redis
  - Coordinates between components
  - Routes requests to LLM and handles responses
- **Prompt Manager**: Manages system prompts for different conversation states
- **Tool/Function Calling Manager**: Routes LLM function calls to appropriate integrations (CRM API, etc.)

### AI Layer
- **Google Gemini API**: Primary LLM for response generation and function calling

### Data & State Layer
- **Redis**: Session state storage for conversation context
- **PostgreSQL**: Persistent storage for logs, users, and analytics

### External Integrations
- **CRM System**: REST API integration for appointment slots, bookings, and customer data

## Data Flow

### Text Messages (Telegram/WhatsApp)
1. Webhook event (JSON) ‚Üí API Gateway
2. Text message ‚Üí Orchestrator
3. Orchestrator loads context from Redis
4. Orchestrator requests system prompt from Prompt Manager
5. Orchestrator sends prompt + context to Gemini
6. Gemini returns response (text or function_call)
7. If function_call: Tool Manager executes ‚Üí CRM/DB ‚Üí returns result to Orchestrator
8. Final response ‚Üí API Gateway ‚Üí Channel ‚Üí User

### Voice Calls
1. Incoming audio stream (RTP/WebSocket) ‚Üí API Gateway
2. Audio data ‚Üí STT Module ‚Üí transcribed text ‚Üí Orchestrator
3. (Same flow as text messages)
4. Text response ‚Üí TTS Module ‚Üí audio stream
5. Outgoing audio ‚Üí API Gateway ‚Üí VoIP provider ‚Üí User

## Key Design Principles

- **Session Management**: All conversation state stored in Redis with session keys
- **Stateless API Gateway**: Gateway only handles transport, all logic in Orchestrator
- **Function Calling Pattern**: LLM decides when to call CRM tools vs. respond directly
- **Multi-modal Support**: Unified orchestrator handles both text and voice through STT/TTS modules
- **Logging**: All sessions and tool executions logged to PostgreSQL for analytics

## Working with This Project

### Before Making Changes
1. **–ß–∏—Ç–∞–π—Ç–µ `docs/architecture.mmd`** - –ø–æ–Ω–∏–º–∞–π—Ç–µ, –∫–∞–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤–ª–∏—è–µ—Ç –Ω–∞ –æ–±—â—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É
2. **–ò—â–∏—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é** - –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å API –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫ —á–µ—Ä–µ–∑ WebSearch
3. **–î—É–º–∞–π—Ç–µ –æ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏** - –±—É–¥–µ—Ç –ª–∏ —Ä–µ—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–∏ 100—Ö –Ω–∞–≥—Ä—É–∑–∫–µ?
4. **–ü—Ä–æ–¥—É–º—ã–≤–∞–π—Ç–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã** - –∫–∞–∫ –¥—Ä—É–≥–∏–µ –º–æ–¥—É–ª–∏ –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤–∞—à –∫–æ–¥?

### When Adding New Features
- **CRM –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è**: —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ –æ—Ç–¥–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å, —Ä–µ–∞–ª–∏–∑—É—é—â–∏–π –æ–±—â–∏–π CRM-–∞–¥–∞–ø—Ç–µ—Ä –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- **–ù–æ–≤—ã–π –∫–∞–Ω–∞–ª —Å–≤—è–∑–∏**: –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–π—Ç–µ —á–µ—Ä–µ–∑ API Gateway, –Ω–µ —Ç—Ä–æ–≥–∞–π—Ç–µ Orchestrator
- **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–æ–≤**: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ Prompt Manager, –Ω–µ —Ö–∞—Ä–¥–∫–æ–¥—å—Ç–µ –ø—Ä–æ–º–ø—Ç—ã –≤ –∫–æ–¥–µ
- **–ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è LLM**: –¥–æ–±–∞–≤–ª—è–π—Ç–µ —á–µ—Ä–µ–∑ Tool Manager —Å —á–µ—Ç–∫–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ–º –¥–ª—è function calling

### Code Quality Standards
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ type hints (Python 3.10+)
- –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –ø—É–±–ª–∏—á–Ω—ã–µ API (docstrings)
- –ü–∏—à–∏—Ç–µ unit-—Ç–µ—Å—Ç—ã –¥–ª—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ async/await –¥–ª—è I/O –æ–ø–µ—Ä–∞—Ü–∏–π
- –õ–æ–≥–∏—Ä—É–π—Ç–µ –≤–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è —Å structured logging
- –•—Ä–∞–Ω–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è, –Ω–µ –≤ –∫–æ–¥–µ

## –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

**–ü–æ—Å–ª–µ –ö–ê–ñ–î–û–ì–û –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ–±–Ω–æ–≤–ª—è–π—Ç–µ:**

### 1. PROJECT_STATUS.md
**–ö–æ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è—Ç—å:**
- –ó–∞–≤–µ—Ä—à–∏–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –∏–ª–∏ —Ñ—É–Ω–∫—Ü–∏–∏
- –ò—Å–ø—Ä–∞–≤–∏–ª–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏
- –î–æ–±–∞–≤–∏–ª–∏ –Ω–æ–≤—ã–µ TODO –∏–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã

**–ß—Ç–æ –æ–±–Ω–æ–≤–ª—è—Ç—å:**
- –°—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞–¥–∞—á (–ø–µ—Ä–µ–≤–æ–¥–∏—Ç–µ –∏–∑ TODO –≤ ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ)
- –ü—Ä–æ—Ü–µ–Ω—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- –û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –ø—Ä–æ–µ–∫—Ç–∞
- –°–ø–∏—Å–æ–∫ –±–ª–∏–∂–∞–π—à–∏—Ö –∑–∞–¥–∞—á

**–ü—Ä–∏–º–µ—Ä:**
```markdown
## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ
- [x] Telegram Bot —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (aiogram 3.x)
- [x] –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∏–º–µ–Ω–∏ –ø–æ–ª—è –≤ CRMTimeSlot

## –ü—Ä–æ–≥—Ä–µ—Å—Å
**–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å**: ~58% (–±—ã–ª–æ 55%)
```

### 2. CHANGELOG.md
**–ö–æ–≥–¥–∞ –æ–±–Ω–æ–≤–ª—è—Ç—å:**
- –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è
- –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–≥–æ–≤
- –ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π

**–§–æ—Ä–º–∞—Ç –∑–∞–ø–∏—Å–∏:**
```markdown
## [–î–∞—Ç–∞] - YYYY-MM-DD

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- –û–ø–∏—Å–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –±–∞–≥–∞

### üöÄ –î–æ–±–∞–≤–ª–µ–Ω–æ
- –û–ø–∏—Å–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–∏

### üîÑ –ò–∑–º–µ–Ω–µ–Ω–æ
- –û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
```

**–ü—Ä–∏–º–µ—Ä:**
```markdown
## 2026-01-09

### ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –∫–æ–Ω—Ñ–ª–∏–∫—Ç –∏–º–µ–Ω–∏ –ø–æ–ª—è `time` –≤ –º–æ–¥–µ–ª–∏ CRMTimeSlot (–ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–æ –≤ `start_time`)
- –î–æ–±–∞–≤–ª–µ–Ω `pydantic[email]` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ EmailStr –≤–∞–ª–∏–¥–∞—Ü–∏–∏

### üöÄ –î–æ–±–∞–≤–ª–µ–Ω–æ
- Telegram Bot –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–±–æ—Ç–∞–µ—Ç —Å polling —Ä–µ–∂–∏–º–æ–º
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è API Gateway —Å AI Agent –∑–∞–≤–µ—Ä—à–µ–Ω–∞

### üîÑ –ò–∑–º–µ–Ω–µ–Ω–æ
- –£–ø—Ä–æ—â–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è: –æ–¥–∏–Ω .env —Ñ–∞–π–ª –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
- Docker build context –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞ –¥–ª—è shared –ø–∞–∫–µ—Ç–æ–≤
```

### 3. –ö–æ–≥–¥–∞ –ù–ï –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
- –ú–µ–ª–∫–∏–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –æ–ø–µ—á–∞—Ç–∫–∏
- –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ .env.example (–Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å)

**–í–ê–ñ–ù–û:** –ï—Å–ª–∏ –≤—ã –Ω–µ —É–≤–µ—Ä–µ–Ω—ã, –Ω—É–∂–Ω–æ –ª–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é - –æ–±–Ω–æ–≤–∏—Ç–µ. –õ—É—á—à–µ –∏–∑–±—ã—Ç–æ—á–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è, —á–µ–º –µ—ë –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ.
